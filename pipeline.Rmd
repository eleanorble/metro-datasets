---
title: "pipeline"
author: "Sifan"
date: "July 29, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/pip.R")
# library(metro.data)

```

## Get a list of places you are interested in
You can type in the metro names and find the corresponding cbsa_codes, as well as the counties within each metro

```{r input places}
find_cbsa_counties("Birmingham")
find_cbsa_counties("grand rapids")
find_cbsa_counties("denver")

places <- purrr::map_df(c("Birmingham", "grand rapids-kentwood", "denver"), find_cbsa_counties)

```

## Use data from ACS summary table

```{r census set up, include = FALSE, echo=FALSE}
library(tidycensus)
library(tidyverse)
library(sjlabelled)

source("R/clean_acs.R")
source("R/acs_var.R")

key <- Sys.getenv("CENSUS_API_KEY")

```

### Specify ACS summary table details
1. geo: The geography of your data. Ex: "state", "county", "tract", "metropolitan statistical area/micropolitan statistical area"
2. yr: The endyear of the ACS sample, 2010 through 2017 are available
3. span: Choose from 1 (ACS 1-year) or 5 (ACS 5-year)
4. var: Character string of variable IDs

```{r ACS inputs}
geo <- "county" # "state", "county", "tract", "metropolitan statistical area/micropolitan statistical area"
yr <- 2017 # ACS year
span <- 5 # 1-year or 5-year
var <- c(pov_race_codes,ed_race_codes) # or search for variables below

# look up other variables 
# tmp <- load_variables(yr,paste0("acs",span),cache = TRUE)
# view(tmp)
# var <- 'S2301_C01_001'

# Optional --------------
# set variables to NULL and use table to get a whole table
# tabl <- "S1701" #if pulling entire table, set variables to NULL

# set boundary, instead of pulling data for all counties
# st  ="AL"
# county = "Jefferson"
# co_acs <- clean_acs(state = st, county = co, 
#                       geography = geo, variables = NULL, 
#                       year = yr, span = span,
#                       key = key, table = tabl)

```

### get data from ACS
```{r county}
co_acs <- clean_acs(geography = geo, variables = var, 
                    year = yr, span = span,
                    key = key, short = FALSE)

head(co_acs)
# get_label(co_acs)

```

#### calculate customized variables based on ACS data
```{r calculate pct race}
calculate_race <-  function(df) {
  df %>%
    mutate(pct_ba_above_wh = S1501_C01_030_estimate/S1501_C01_028_estimate,
           pct_ba_above_bk = S1501_C01_036_estimate/S1501_C01_034_estimate,
           pct_belowpoverty_wh = S1701_C03_013_estimate/100,
           pct_belowpoverty_bk = S1701_C03_014_estimate/100) %>%
    select(-contains("estimate"),-contains("moe"))
  }
  
co_race <- calculate_race(co_acs)
head(co_race)
```


### get data from cbsa
```{r get cbsa data}
var <- drive_codes
# metro.data::acs_var$
geo <- "metropolitan statistical area/micropolitan statistical area"
cbsa_acs <- clean_acs(geography = geo, variables = var, 
                      year = yr, span = span,
                      key = key, short = FALSE)

```
#### calculate customized variables based on ACS data
```{r calculate pct}
cbsa_commute <- cbsa_acs %>%
  mutate(pct_drivealone = S0802_C02_001_estimate/S0802_C01_001_estimate)%>%
  select(-contains("estimate"),-contains("moe"))
head(cbsa_commute)
```

## get data from all datasets for places of interests
You can select the datasets you need, including the ACS summary tables you just downloaded and customized, for the places you selected

```{r merge all datasets }
# supply datasets of interests 
list_county_all <- list(co_uspto, county_univ_rd, export_monitor_county, co_race)
list_cbsa_all <- list(cbsa_uspto, cbsa_i5hgc, cbsa_metromonitor, cbsa_patentcomplex,cbsa_univ_rd)

# merge all datasets and keep the latest year only
cbsa_df <- merge_cbsa(lapply(list_cbsa_all, keep_latest)) 
county_df <- merge_county(lapply(list_county_all, keep_latest)) 


```

### show data

```{r data table}
# find cbsa data 
cbsa_output <- cbsa_df %>%
  filter(cbsa_code %in% places$cbsa_code)

head(cbsa_output)

# find county data
county_df %>%
  filter(stco_code %in% places$stco_code)
```

## Plot

Create quick bar plots to compare across peer groups

```{r, include=FALSE}
quick_bar = function(df, var,wt = F, scale = 1, acc = 0.1){
  df <- df %>% mutate_(value = var) %>%
    mutate(value = value*scale)
  
  if (wt) {df <- df %>% mutate(value = value/jobs)}
  
  metro.data::bbplot(df, 
                   aes(x = reorder(cbsa_name,value), y = value, fill = cbsa_name))+
  geom_bar(stat = "identity")+
  geom_text(aes(label = scales::comma(value,acc)), position = "identity")+
  coord_flip()+
  ggtitle(var)
  
  # return(df)
}

```


```{r plot, echo = FALSE}
quick_bar(cbsa_output, "rd_total",wt = T)
quick_bar(cbsa_output, "patents_issued", wt = T, scale = 1000)
quick_bar(cbsa_output, "patent_complexity")
quick_bar(cbsa_output, "i5hgc_density")
quick_bar(cbsa_output, "employment_at_firms_0_5_years_old", wt = T, acc = 0.01)

```

